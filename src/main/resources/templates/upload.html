<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<head th:replace="~{fragments/header :: head}"></head>

<body>
  <div th:replace="~{fragments/header :: header}"></div>
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link rel="stylesheet" th:href="@{/css/upload.css}">

  <main id="upload">
    <h2>Upload a File</h2>

    <form id="uploadForm" method="post" enctype="multipart/form-data">
      <input type="file" name="file" id="fileInput" required>
      <button type="submit">Upload</button>
    </form>

    <div id="uploadStatus" aria-live="polite" hidden>
      <progress id="progressBar" value="0" max="100"></progress>
      <p id="progressText">0%</p>
    </div>

    <div id="resultMessage" hidden></div>
  </main>

  <div th:replace="~{fragments/footer :: footer}"></div>

  <script>
    function copyCombined(button) {
      const url = document.getElementById('downloadUrl').href;
      const password = document.getElementById('passwordText').textContent;
      const formatted = `URL: ${url}\nPassword: ${password}`;
      navigator.clipboard.writeText(formatted).then(() => {
        const original = button.textContent;
        button.textContent = 'Copied';
        setTimeout(() => { button.textContent = original; }, 1500);
      });
    }

    document.getElementById('uploadForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/upload', true);

      const progressBar   = document.getElementById('progressBar');
      const progressText  = document.getElementById('progressText');
      const uploadStatus  = document.getElementById('uploadStatus');
      const resultMessage = document.getElementById('resultMessage');

      uploadStatus.hidden = false;
      progressBar.value = 0;
      progressText.textContent = '0%';
      resultMessage.hidden = true;
      resultMessage.innerHTML = '';

      xhr.upload.addEventListener('progress', function (e) {
        if (e.lengthComputable) {
          const percentComplete = Math.round((e.loaded / e.total) * 100);
          progressBar.value = percentComplete;
          progressText.textContent = percentComplete + '%';
        }
      });

      xhr.onload = function () {
        let response;
        try { response = JSON.parse(xhr.responseText); } catch { response = {}; }

        if (xhr.status === 200 && response.downloadUrl && response.password) {
          resultMessage.innerHTML = `
            <div class="result-inner">
              <h3>Upload Successful</h3>
              <a id="downloadUrl" href="${response.downloadUrl}" hidden>${response.downloadUrl}</a>
              <span id="passwordText" hidden>${response.password}</span>
              <button class="copy-combo" onclick="copyCombined(this)">Copy URL & Password</button>
              <p class="warning">This is the only time you'll see the password. Save it.</p>
            </div>
          `;
          fileInput.value = '';
          uploadStatus.hidden = true;
          resultMessage.hidden = false;
        } else {
          resultMessage.textContent = (response.error || 'Upload failed. Try again.');
          resultMessage.hidden = false;
        }
      };

      xhr.onerror = function () {
        resultMessage.textContent = "An error occurred during the upload.";
        resultMessage.hidden = false;
      };

      xhr.send(formData);
    });
  </script>
</body>
</html>
